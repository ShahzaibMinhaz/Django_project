<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Document</title>
</head>
<body>
    <form action="" method="POST" class="mb-3 mt-4 container">
        {% csrf_token %}
        {{ form }}
        <input type="Submit" value="Submit" class="submit">
    </form>
    <table class="table container w-75">
        <thead>
          <tr>
            <th scope="col">Item Name</th>
            <th scope="col">Item quentity</th>
            <th scope="col">Item Price</th>
            <th scope="col">Total Price</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <div class="input-group w-25 float-right mt-5 container mr-5">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Total Price</span>
        </div>
        <input type="text" disabled class="form-control TotalPrice" placeholder="0" aria-label="Username" aria-describedby="basic-addon1">
        <input type="button" class="btn btn-success mt-3 SubmitInvoice" value="Submit Invoice Data">
      </div>
     
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajaxy/1.6.1/scripts/jquery.ajaxy.min.js"></script>
<script type="text/javascript">

    // initialize total price variable 
    Total_price = 0

    // initialize array to save all data of table 
    var ary = [];

    // submit button 
    $(document ).ready(function() {

        // Submit data to row button    
        $('.submit').click(function(e){
            e.preventDefault();

            // getting values from input field
            name = $('#item_name').val()
            quantity = $('#item_quantity').val()
            price = $('#item_price').val()

            //calculating total
            ItemTotal_Price = quantity*price
            Total_price = Total_price + ItemTotal_Price
            // Update  total price 


            //appending data to table
            $('.table').append('<tr><td scope="row">'+name+'</td><td>'+quantity+'</td><td>'+price+'</td><td>'+ItemTotal_Price+'</td><td><input id="delbtn type="button" value="DELETE" class="btn btn-danger"/></td></tr>');
           
            // setting input 
            $('#item_name').val('')
            $('#item_quantity').val('')
            $('#item_price').val('')
            $('.TotalPrice').val(Total_price)

        });
        
        // delete row with row button 
        $(document).on('click', '.btn-danger', function() {
            // get delete item total price 
            var price = $(this).closest("tr").find('td:nth-child(4)').text();

            // update total price 
            Total_price = Total_price - price
            console.log(Total_price)

            // set total price 
            $('.TotalPrice').val(Total_price)
             
            // remove tr from table 
            $(this).parent().parent('tr').remove();
        });
        // initialize array to save all data of table 
        var ary = [];
        // Submit Invoice Data button 
        $('.SubmitInvoice').click(function(e){
            e.preventDefault()
            alert('Submit Invoice')

            // get all data of table in array ary
            var table = $(".table");
            table.find('tr').each(function (i, el) {
                // i = 0 not included b/c of header 
                if(i!=0){ 
                    console.log(i+''+el)
                    var $tds = $(this).find('td'),
                    productName = $tds.eq(0).text(),
                    productQuantity = $tds.eq(1).text(),
                    productPrice = $tds.eq(2).text();
                    ary.push({ productName: productName, productQuantity: productQuantity,productPrice:productPrice });
                }
            });
            console.log(ary)
           

            // set total price to zero
            $('.TotalPrice').val('')
            submitData() 
        });

        // function to get cookies 
        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }}

        // function to send data to django 
        function submitData() {
            $.ajax({
                headers:{
                    "X-CSRFToken": getCookie("csrftoken")
                },
                url : "submitinvoice/", // the endpoint
                type : "POST", // http method
                data : { 'table_Data' : JSON.stringify(ary),'total_Price': Total_price }, // data sent with the post request

                // handle a successful response
                success : function(data) {
                    // $('#post-text').val(''); // remove the value from the input
                    // alert(json)

                    var table = $(".table");
                     // remove data after submitting data 
                    table.children('tbody').children('tr').remove();
                    ary.
                    console.log(data); // log the returned json to the console
                    // console.log("success"); // another sanity check
                },

                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            });
        };
    });
</script>
</body>
</html>